<% content_for :title, "#{@festival.name} - 支払い一覧" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">支払い一覧</h1>
        <%= link_to "新規支払い", new_festival_payment_path(@festival), class: "btn btn-primary" %>
      </div>

      <!-- Payment Filters -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">フィルター</h5>
        </div>
        <div class="card-body">
          <%= form_with url: festival_payments_path(@festival), method: :get, local: true, class: "row g-3" do |form| %>
            <div class="col-md-3">
              <%= form.select :status, options_for_select([
                ['すべて', ''],
                ['保留中', 'pending'],
                ['処理中', 'processing'],
                ['完了', 'completed'],
                ['失敗', 'failed'],
                ['キャンセル', 'cancelled']
              ], params[:status]), {}, { class: "form-select" } %>
            </div>
            <div class="col-md-3">
              <%= form.date_field :start_date, value: params[:start_date], placeholder: "開始日", class: "form-control" %>
            </div>
            <div class="col-md-3">
              <%= form.date_field :end_date, value: params[:end_date], placeholder: "終了日", class: "form-control" %>
            </div>
            <div class="col-md-3">
              <%= form.submit "絞り込み", class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Payments Table -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">支払い履歴</h5>
        </div>
        <div class="card-body">
          <% if @payments.any? %>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>金額</th>
                    <th>決済方法</th>
                    <th>ステータス</th>
                    <th>顧客名</th>
                    <th>作成日</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <% @payments.each do |payment| %>
                    <tr>
                      <td><%= link_to payment.id, festival_payment_path(@festival, payment) %></td>
                      <td><%= payment.formatted_amount %></td>
                      <td>
                        <span class="badge bg-info">
                          <%= payment.payment_method.humanize %>
                        </span>
                      </td>
                      <td>
                        <span class="badge bg-<%= payment.status_color %>">
                          <%= payment.status.humanize %>
                        </span>
                      </td>
                      <td><%= payment.customer_name %></td>
                      <td><%= payment.created_at.strftime("%Y-%m-%d %H:%M") %></td>
                      <td>
                        <%= link_to "詳細", festival_payment_path(@festival, payment), class: "btn btn-sm btn-outline-primary" %>
                        <% if payment.can_be_modified_by?(current_user) %>
                          <%= link_to "編集", edit_festival_payment_path(@festival, payment), class: "btn btn-sm btn-outline-secondary" %>
                        <% end %>
                        <% if payment.can_be_cancelled_by?(current_user) %>
                          <%= link_to "キャンセル", festival_payment_path(@festival, payment), method: :delete, 
                                      confirm: "本当にキャンセルしますか？", class: "btn btn-sm btn-outline-danger" %>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-5">
              <i class="bi bi-credit-card fs-1 text-muted"></i>
              <p class="text-muted mt-3">まだ支払いがありません。</p>
              <%= link_to "新規支払いを作成", new_festival_payment_path(@festival), class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>